generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum AQISource {
  INTERNAL
  WAQI
  OPENAQI
}

enum ContentWriterStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum AccountType {
  PERSONAL
  ORGANIZATION
}

enum DeviceStatus {
  UNASSIGNED
  ASSIGNED
}

enum DeviceType {
  INDOOR
  OUTDOOR
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum DeviceSubscriptionStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

enum SubscriptionDuration {
  THREE_MONTHS // 3 Months
  SIX_MONTHS // 6 Months
  TWELVE_MONTHS // 12 Months
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ExportFormat {
  CSV
  XLSX
  PDF
  JSON
}

enum CalibrationStatus {
  PENDING
  SUCCESS
  FAILED
}

enum InvoiceStatus {
  GENERATED
  PAID
  VOID
  REFUNDED
}

enum AuditActorType {
  USER
  ADMIN
  SYSTEM
  WEBHOOK
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  ADMIN_OVERRIDE
  PAYMENT_FAILED
  PAYMENT_SUCCESS
  REFUND
}

//////////////////////////////////////////////////////
// USER & ADMIN
//////////////////////////////////////////////////////

model User {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String       @unique
  recoveryEmail String?
  phoneNumber   String?
  password      String?
  authProvider  AuthProvider @default(LOCAL)

  sensorId         String?
  accountType      AccountType @default(PERSONAL)
  organizationName String?

  comments  Comment[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  devices   Device[]

  deviceSubscriptions DeviceSubscription[]
  payments            Payment[]
  couponRedemptions   CouponRedemption[]
  exportLogs          ExportLog[]
  invoices            Invoice[]
}

model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  calibrations Calibration[]
}

//////////////////////////////////////////////////////
// AQI TABLES
//////////////////////////////////////////////////////

model DeviceModel {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  name         String  @unique // ex: "PurpleAir PA-II"
  description  String
  manufacturer String
  isActive     Boolean @default(true)

  pricingPlans PricingPlan[]

  devices Device[]

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Device {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  name     String?
  serialNo String     @unique
  isActive Boolean    @default(true)
  apiKey   String
  type     DeviceType @default(OUTDOOR)
  loaction String?

  lat Float?
  lng Float?

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  status DeviceStatus @default(UNASSIGNED)

  modelId String      @db.ObjectId
  model   DeviceModel @relation(fields: [modelId], references: [id])

  assignedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  sensorReadings          SensorReading[]
  hourlyAggregateReadings HourlyAggregateReading[]
  dailyAggregateReadings  DailyAggregateReading[]

  payments            Payment[]
  couponRedemptions   CouponRedemption[]
  deviceSubscriptions DeviceSubscription[]

  exportLogs ExportLog[]

  calibrations Calibration[]

  latestSensorReadings latestSensorReading?
}

model AQIReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Location
  lat      Float
  lng      Float
  location String
  city     String
  state    String
  country  String @default("India")

  // Pollution Data
  aqi  Int
  pm25 Float?
  pm10 Float?
  no2  Float?
  so2  Float?
  o3   Float?
  co   Float?

  // Weather Data
  temperature Float? // °C
  humidity    Float? // %

  // MetaData
  source     AQISource
  stationId  String?
  measuredAt DateTime

  // Creation Date
  createdAt DateTime @default(now())

  @@unique([lat, lng, source, measuredAt], name: "lat_lng_source_measuredAt")
  @@index([lat, lng])
  @@index([measuredAt])
  @@index([source])
  @@index([city])
  @@index([state])
  @@index([location, measuredAt])
}

model latestSensorReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @unique @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Pollution Data
  aqi     Float
  pm10    Float?
  pm25    Float?
  so2     Float?
  no2     Float?
  co2     Float?
  co      Float?
  o3      Float?
  noise   Float?
  pm1     Float?
  tvoc    Float?
  smoke   Float?
  methane Float?
  h2      Float?
  ammonia Float?
  h2s     Float?

  // Weather Data
  temperature Float? // °C
  humidity    Float? // %

  measuredAt DateTime

  updatedAt DateTime @updatedAt
}

model SensorReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Pollution Data
  aqi     Float
  pm10    Float?
  pm25    Float?
  so2     Float?
  no2     Float?
  co2     Float?
  co      Float?
  o3      Float?
  noise   Float?
  pm1     Float?
  tvoc    Float?
  smoke   Float?
  methane Float?
  h2      Float?
  ammonia Float?
  h2s     Float?

  // Weather Data
  temperature Float? // °C
  humidity    Float? // %

  measuredAt DateTime

  createdAt DateTime @default(now())

  @@unique([deviceId, measuredAt(sort: Desc)], name: "deviceId_measuredAt")
}

model HourlyAggregateReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  hourStart DateTime

  // Common count
  count Int

  // Pollution aggregates
  sumAqi Float
  minAqi Float
  maxAqi Float

  sumPm10 Float?
  minPm10 Float?
  maxPm10 Float?

  sumPm25 Float?
  minPm25 Float?
  maxPm25 Float?

  sumSo2 Float?
  minSo2 Float?
  maxSo2 Float?

  sumNo2 Float?
  minNo2 Float?
  maxNo2 Float?

  sumCo2 Float?
  minCo2 Float?
  maxCo2 Float?

  sumCo Float?
  minCo Float?
  maxCo Float?

  sumO3 Float?
  minO3 Float?
  maxO3 Float?

  sumNoise Float?
  minNoise Float?
  maxNoise Float?

  sumPM1 Float?
  minPM1 Float?
  maxPM1 Float?

  sumTvoc Float?
  minTvoc Float?
  maxTvoc Float?

  sumSmoke Float?
  minSmoke Float?
  maxSmoke Float?

  sumMethane Float?
  minMethane Float?
  maxMethane Float?

  sumH2 Float?
  minH2 Float?
  maxH2 Float?

  sumAmmonia Float?
  minAmmonia Float?
  maxAmmonia Float?

  sumH2s Float?
  minH2s Float?
  maxH2s Float?

  // Weather aggregates
  sumTemperature Float?
  minTemperature Float?
  maxTemperature Float?

  sumHumidity Float?
  minHumidity Float?
  maxHumidity Float?

  createdAt DateTime @default(now())

  // @@unique([deviceId, hourStart], name: "deviceId_hourStart")
  @@index([hourStart])
  @@index([deviceId, hourStart])
}

model DailyAggregateReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  dayStart DateTime

  // Common count
  count Int

  // Pollution aggregates
  sumAqi Float
  minAqi Float
  maxAqi Float

  sumPm10 Float?
  minPm10 Float?
  maxPm10 Float?

  sumPm25 Float?
  minPm25 Float?
  maxPm25 Float?

  sumSo2 Float?
  minSo2 Float?
  maxSo2 Float?

  sumNo2 Float?
  minNo2 Float?
  maxNo2 Float?

  sumCo2 Float?
  minCo2 Float?
  maxCo2 Float?

  sumCo Float?
  minCo Float?
  maxCo Float?

  sumO3 Float?
  minO3 Float?
  maxO3 Float?

  sumNoise Float?
  minNoise Float?
  maxNoise Float?

  sumPM1 Float?
  minPM1 Float?
  maxPM1 Float?

  sumTvoc Float?
  minTvoc Float?
  maxTvoc Float?

  sumSmoke Float?
  minSmoke Float?
  maxSmoke Float?

  sumMethane Float?
  minMethane Float?
  maxMethane Float?

  sumH2 Float?
  minH2 Float?
  maxH2 Float?

  sumAmmonia Float?
  minAmmonia Float?
  maxAmmonia Float?

  sumH2s Float?
  minH2s Float?
  maxH2s Float?

  // Weather aggregates
  sumTemperature Float?
  minTemperature Float?
  maxTemperature Float?

  sumHumidity Float?
  minHumidity Float?
  maxHumidity Float?

  createdAt DateTime @default(now())

  // @@unique([deviceId, dayStart], name: "deviceId_dayStart")
  @@index([dayStart])
  @@index([deviceId, dayStart])
}

model Calibration {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  performedById String? @db.ObjectId
  performedBy   Admin?  @relation(fields: [performedById], references: [id])

  // Calibration lifecycle
  status         CalibrationStatus @default(PENDING)
  expiresAt      DateTime
  acknowledgedAt DateTime?

  previousValues Json?
  newValues      Json

  reason String?

  effectiveFrom DateTime
  deliveredAt   DateTime?
  createdAt     DateTime  @default(now())

  @@index([deviceId, status])
  @@index([expiresAt])
}

//////////////////////////////////////////////////////
// BLOG SYSTEM
//////////////////////////////////////////////////////

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  slug        String  @unique
  title       String
  description String?

  posts BlogPostCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentWriter {
  id       String              @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  username String              @unique
  email    String              @unique
  password String
  status   ContentWriterStatus @default(ACTIVE)

  posts    BlogPost[]
  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  title String
  desc  String
  img   String?
  views Int     @default(0)

  authorId String        @db.ObjectId
  author   ContentWriter @relation(fields: [authorId], references: [id], onDelete: Cascade)

  likedIds   String[] @db.ObjectId
  likesCount Int      @default(0)

  categories BlogPostCategory[]
  comments   Comment[]

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  editorPick EditorPick?

  @@index([authorId])
}

model BlogPostCategory {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  postId     String @db.ObjectId
  categoryId String @db.ObjectId

  post     BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, categoryId])
}

model EditorPick {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  postId String @db.ObjectId

  post BlogPost @relation(fields: [postId], references: [id])

  createdAt DateTime @default(now())

  @@unique([postId])
}

model Comment {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  desc String

  authorId String        @db.ObjectId
  author   ContentWriter @relation(fields: [authorId], references: [id], onDelete: Cascade)

  postId String   @db.ObjectId
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?  @db.ObjectId

  @@index([postId])
}

//////////////////////////////////////////////////////
// SITE STATS
//////////////////////////////////////////////////////
model SiteStats {
  id         String   @id @default("views") @map("_id")
  totalViews Int      @default(0)
  dailyViews Int      @default(0)
  lastReset  DateTime @default(now())
}

//////////////////////////////////////////////////////
// Payment, Subscription and Coupons 
//////////////////////////////////////////////////////

model PricingPlan {
  id      String      @id @default(auto()) @map("_id") @db.ObjectId
  modelId String      @db.ObjectId
  model   DeviceModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  duration SubscriptionDuration
  price    Float // e.g., 2999.00
  currency String               @default("INR")

  // Admin Toggle
  isEnabled Boolean @default(true)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([modelId, duration]) // One price per duration per model
}

model DeviceSubscription {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime

  // Track what was paid
  paidAmount Float
  planType   SubscriptionDuration

  // For Admin Tracking
  adminModified Boolean @default(false)
  notes         String? // Admin can leave a note why they modified it

  status    DeviceSubscriptionStatus @default(ACTIVE)
  autoRenew Boolean                  @default(false)

  payments Payment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  invoices  Invoice[]

  @@index([deviceId])
  @@index([userId])
  @@index([endDate])
  @@index([status])
}

model Coupon {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  code        String  @unique
  description String?

  discountType  DiscountType
  discountValue Float

  maxUsage        Int?
  usedCount       Int  @default(0)
  maxUsagePerUser Int?

  validFrom  DateTime
  validUntil DateTime

  isActive Boolean @default(true)

  payments          Payment[]
  couponRedemptions CouponRedemption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CouponRedemption {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  couponId String @db.ObjectId
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  paymentId String  @unique @db.ObjectId
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  discountApplied Float

  createdAt DateTime @default(now())

  @@index([couponId])
  @@index([userId])
  @@index([deviceId])
}

model Payment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  deviceSubscriptionId String?             @db.ObjectId
  deviceSubscription   DeviceSubscription? @relation(fields: [deviceSubscriptionId], references: [id], onDelete: SetNull)

  couponId String? @db.ObjectId
  coupon   Coupon? @relation(fields: [couponId], references: [id], onDelete: SetNull)

  amount         Float
  discountAmount Float?
  finalAmount    Float

  currency String @default("INR")

  status PaymentStatus @default(PENDING)

  razorpayOrderId   String  @unique
  razorpayPaymentId String? @unique
  razorpaySignature String?

  metadata Json?

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  couponRedemption CouponRedemption?
  invoice          Invoice?

  @@index([userId])
  @@index([deviceId])
  @@index([deviceSubscriptionId])
  @@index([couponId])
}

model Invoice {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  invoiceNumber String @unique
  userId        String @db.ObjectId
  user          User   @relation(fields: [userId], references: [id])

  paymentId String  @unique @db.ObjectId
  payment   Payment @relation(fields: [paymentId], references: [id])

  deviceSubscriptionId String?             @db.ObjectId
  deviceSubscription   DeviceSubscription? @relation(fields: [deviceSubscriptionId], references: [id])

  subtotal    Float
  taxAmount   Float
  totalAmount Float

  currency String @default("INR")

  billingName    String?
  billingEmail   String?
  billingAddress String?
  gstNumber      String?

  s3Key String?

  status InvoiceStatus @default(GENERATED)

  issuedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AuditLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  entityType String
  entityId   String

  action AuditAction

  actorId   String
  actorType AuditActorType

  oldData Json?
  newData Json?

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// Export Logs
//////////////////////////////////////////////////////
model ExportLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String? @db.ObjectId
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  format ExportFormat
  status ExportStatus @default(PENDING)

  fromDate DateTime?
  toDate   DateTime?

  fileUrl  String?
  fileSize Float?

  errorMessage String?

  requestedAt DateTime  @default(now())
  completedAt DateTime?

  metadata Json?

  @@index([userId])
  @@index([deviceId])
  @@index([status])
  @@index([requestedAt])
}
