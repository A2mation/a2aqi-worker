generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum AQISource {
  INTERNAL
  WAQI
  OPENAQI
}

enum ContentWriterStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum AccountType {
  PERSONAL
  ORGANIZATION
}

enum DeviceStatus {
  UNASSIGNED
  ASSIGNED
}

//////////////////////////////////////////////////////
// USER & ADMIN
//////////////////////////////////////////////////////

model User {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String       @unique
  recoveryEmail String?
  phoneNumber   String?
  password      String?
  authProvider  AuthProvider @default(LOCAL)

  sensorId         String?
  accountType      AccountType @default(PERSONAL)
  organizationName String?

  comments  Comment[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  devices   Device[]
}

model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// AQI TABLES
//////////////////////////////////////////////////////

model DeviceModel {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  name         String @unique // ex: "PurpleAir PA-II"
  manufacturer String

  isActive Boolean @default(true)

  description String

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  devices Device[]
}

model Device {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  name     String?
  serialNo String  @unique
  isActive Boolean @default(true)
  apiKey   String

  lat Float?
  lng Float?

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  status DeviceStatus @default(UNASSIGNED)

  modelId String      @db.ObjectId
  model   DeviceModel @relation(fields: [modelId], references: [id])

  assignedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  sensorReadings          SensorReading[]
  hourlyAggregateReadings HourlyAggregateReading[]
  dailyAggregateReadings  DailyAggregateReading[]
}

model AQIReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Location
  lat      Float
  lng      Float
  location String
  city     String
  state    String
  country  String @default("India")

  // Pollution Data
  aqi  Int
  pm25 Float?
  pm10 Float?
  no2  Float?
  so2  Float?
  o3   Float?
  co   Float?

  // Weather Data
  temperature Float? // °C
  humidity    Float? // %

  // MetaData
  source     AQISource
  stationId  String?
  measuredAt DateTime

  // Creation Date
  createdAt DateTime @default(now())

  @@unique([lat, lng, source, measuredAt], name: "lat_lng_source_measuredAt")
  @@index([lat, lng])
  @@index([measuredAt])
  @@index([source])
  @@index([city])
  @@index([state])
  @@index([location, measuredAt])
}

model SensorReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // Pollution Data
  aqi     Float?
  pm10    Float?
  pm25    Float?
  so2     Float?
  no2     Float?
  co2     Float?
  co      Float?
  o3      Float?
  noise   Float?
  pm1     Float?
  tvoc    Float?
  smoke   Float?
  methane Float?
  h2      Float?
  ammonia Float?
  h2s     Float?

  // Weather Data
  temperature Float? // °C
  humidity    Float? // %

  measuredAt DateTime

  createdAt DateTime @default(now())

  @@unique([deviceId, measuredAt], name: "deviceId_measuredAt")
  @@index([deviceId])
}

model HourlyAggregateReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  hourStart DateTime

  // Common count
  count Int

  // Pollution aggregates
  sumAqi Float?
  minAqi Float?
  maxAqi Float?

  sumPm10 Float?
  minPm10 Float?
  maxPm10 Float?

  sumPm25 Float?
  minPm25 Float?
  maxPm25 Float?

  sumSo2 Float?
  minSo2 Float?
  maxSo2 Float?

  sumNo2 Float?
  minNo2 Float?
  maxNo2 Float?

  sumCo2 Float?
  minCo2 Float?
  maxCo2 Float?

  sumCo Float?
  minCo Float?
  maxCo Float?

  sumO3 Float?
  minO3 Float?
  maxO3 Float?

  sumNoise Float?
  minNoise Float?
  maxNoise Float?

  sumPM1 Float?
  minPM1 Float?
  maxPM1 Float?

  sumTvoc Float?
  minTvoc Float?
  maxTvoc Float?

  sumSmoke Float?
  minSmoke Float?
  maxSmoke Float?

  sumMethane Float?
  minMethane Float?
  maxMethane Float?

  sumH2 Float?
  minH2 Float?
  maxH2 Float?

  sumAmmonia Float?
  minAmmonia Float?
  maxAmmonia Float?

  sumH2s Float?
  minH2s Float?
  maxH2s Float?

  // Weather aggregates
  sumTemperature Float?
  minTemperature Float?
  maxTemperature Float?

  sumHumidity Float?
  minHumidity Float?
  maxHumidity Float?

  createdAt DateTime @default(now())

  // @@unique([deviceId, hourStart], name: "deviceId_hourStart")
  @@index([hourStart])
  @@index([deviceId, hourStart])
}

model DailyAggregateReading {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  dayStart DateTime

  // Common count
  count Int

  // Pollution aggregates
  sumAqi Float?
  minAqi Float?
  maxAqi Float?

  sumPm10 Float?
  minPm10 Float?
  maxPm10 Float?

  sumPm25 Float?
  minPm25 Float?
  maxPm25 Float?

  sumSo2 Float?
  minSo2 Float?
  maxSo2 Float?

  sumNo2 Float?
  minNo2 Float?
  maxNo2 Float?

  sumCo2 Float?
  minCo2 Float?
  maxCo2 Float?

  sumCo Float?
  minCo Float?
  maxCo Float?

  sumO3 Float?
  minO3 Float?
  maxO3 Float?

  sumNoise Float?
  minNoise Float?
  maxNoise Float?

  sumPM1 Float?
  minPM1 Float?
  maxPM1 Float?

  sumTvoc Float?
  minTvoc Float?
  maxTvoc Float?

  sumSmoke Float?
  minSmoke Float?
  maxSmoke Float?

  sumMethane Float?
  minMethane Float?
  maxMethane Float?

  sumH2 Float?
  minH2 Float?
  maxH2 Float?

  sumAmmonia Float?
  minAmmonia Float?
  maxAmmonia Float?

  sumH2s Float?
  minH2s Float?
  maxH2s Float?

  // Weather aggregates
  sumTemperature Float?
  minTemperature Float?
  maxTemperature Float?

  sumHumidity Float?
  minHumidity Float?
  maxHumidity Float?

  createdAt DateTime @default(now())

  // @@unique([deviceId, dayStart], name: "deviceId_dayStart")
  @@index([dayStart])
  @@index([deviceId, dayStart])
}

//////////////////////////////////////////////////////
// BLOG SYSTEM
//////////////////////////////////////////////////////

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  slug        String  @unique
  title       String
  description String?

  posts BlogPostCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ContentWriter {
  id       String              @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  username String              @unique
  email    String              @unique
  password String
  status   ContentWriterStatus @default(ACTIVE)

  posts    BlogPost[]
  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  title String
  desc  String
  img   String?
  views Int     @default(0)

  authorId String        @db.ObjectId
  author   ContentWriter @relation(fields: [authorId], references: [id], onDelete: Cascade)

  likedIds   String[] @db.ObjectId
  likesCount Int      @default(0)

  categories BlogPostCategory[]
  comments   Comment[]

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  editorPick EditorPick?

  @@index([authorId])
}

model BlogPostCategory {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  postId     String @db.ObjectId
  categoryId String @db.ObjectId

  post     BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([postId, categoryId])
}

model EditorPick {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  postId String @db.ObjectId

  post BlogPost @relation(fields: [postId], references: [id])

  createdAt DateTime @default(now())

  @@unique([postId])
}

model Comment {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  desc String

  authorId String        @db.ObjectId
  author   ContentWriter @relation(fields: [authorId], references: [id], onDelete: Cascade)

  postId String   @db.ObjectId
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?  @db.ObjectId

  @@index([postId])
}

//////////////////////////////////////////////////////
// SITE STATS
//////////////////////////////////////////////////////
model SiteStats {
  id         String   @id @default("views") @map("_id")
  totalViews Int      @default(0)
  dailyViews Int      @default(0)
  lastReset  DateTime @default(now())
}
